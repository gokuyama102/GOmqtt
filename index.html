<!DOCTYPE html>
<html>
<style>
    body {
        font-family: Arial, sans-serif;
        padding-left: 3%;
        padding-right: 3%;
        width: 960px;
        margin: auto;
    }

    /*IOLM Status */
    .geral {
        width: 960px;

    }

    .framePort {
        width: 420px;
        height: 130px;
        background-color: lightgray;
        padding: 15px;
        margin: 10px;
    }

    #coluna1 {
        float: left;
        width: 470px;

    }

    .portImage {
        float: left;
        margin-right: 15px;
        background-color: white;
        margin-top: auto;
        margin-bottom: auto;
    }

    .port {
        display: inline;
    }

    #coluna2 {
        float: right;
        width: 480px;
    }

    /* Make topic text bold */
    li,
    #myUL {
        font-weight: bold;
    }

    /* Remove default bullets */
    ul,
    #myUL {
        list-style-type: none;
        font-weight: normal;
    }

    /* Remove margins and padding from the parent ul */
    #myUL {
        margin: 0;
        padding: 2%;
        padding-top: 0;
    }

    /* Style the caret/arrow */
    .caret {
        cursor: pointer;
        user-select: none;
        /* Prevent text selection */
    }

    /* Create the caret/arrow with a unicode, and style it */
    .caret::before {
        /*content: "\25B6";*/
        content: "+";
        color: black;
        display: inline-block;
        margin-right: 6px;
    }

    /* Rotate the caret/arrow icon when clicked on (using JavaScript) */
    .caret-down::before {
        /*transform: rotate(90deg);*/
        content: "-";
    }

    /* Hide the nested list */
    .nested {
        display: none;
    }

    /* Show the nested list when the user clicks on the caret/arrow (with JavaScript) */
    .active {
        display: block;
    }

    #log {
        padding-left: 2%;
        padding-right: 2%;
    }
</style>

<body>
    <h1>IOLM Port Status</h1>
    <div class="geral">
        <div id="principal">
            <div id="coluna1">
                <div id="coluna1-2">
                    <div id="framePort1" class="framePort">
                        <img class="portImage" id="pImage1"
                            src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D" width=100 height=110>
                        <p id="port1" class="port">
                            <b>Port 1</b>
                            <br>Device: <a id="port1/prodname"></a>
                            <br>Serial: <a id="port1/serial"></a>
                            <br>Status: <a id="port1/status"></a>
                            <diagnostic id="diagPort1">
                                <br>PDI: <a id="port1/pdi"></a>
                            </diagnostic>
                        </p>
                    </div>
                    <div id="framePort3" class="framePort">
                        <img class="portImage" id="pImage3"
                            src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D" width=100 height=110>
                        <p id="port3" class="port">
                            <b>Port 3</b>
                            <br>Device: <a id="port3/prodname"></a>
                            <br>Serial: <a id="port3/serial"></a>
                            <br>Status: <a id="port3/status"></a>
                            <diagnostic id="diagPort3">
                                <br>PDI: <a id="port3/pdi"></a>
                            </diagnostic>
                        </p>
                    </div>
                    <div id="framePort5" class="framePort">
                        <img class="portImage" id="pImage5"
                            src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D" width=100 height=110>
                        <p id="port5" class="port">
                            <b>Port 5</b>
                            <br>Device: <a id="port5/prodname"></a>
                            <br>Serial: <a id="port5/serial"></a>
                            <br>Status: <a id="port5/status"></a>
                            <diagnostic id="diagPort5">
                                <br>PDI: <a id="port5/pdi"></a>
                            </diagnostic>
                        </p>
                    </div>
                    <div id="framePort7" class="framePort">
                        <img class="portImage" id="pImage7"
                            src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D" width=100 height=110>
                        <p id="port7" class="port">
                            <b>Port 7</b>
                            <br>Device: <a id="port7/prodname"></a>
                            <br>Serial: <a id="port7/serial"></a>
                            <br>Status: <a id="port7/status"></a>
                            <diagnostic id="diagPort7">
                                <br>PDI: <a id="port7/pdi"></a>
                            </diagnostic>
                        </p>
                    </div>
                </div>

            </div>
            <div id="coluna2">
                <div id="coluna2-1">

                </div>
                <div id="coluna2-2">
                    <div id="framePort2" class="framePort">
                        <img class="portImage" id="pImage2"
                            src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D" width=100 height=110>
                        <p id="port2" class="port">
                            <b>Port 2</b>
                            <br>Device: <a id="port2/prodname"></a>
                            <br>Serial: <a id="port2/serial"></a>
                            <br>Status: <a id="port2/status"></a>
                            <diagnostic id="diagPort2">
                                <br>PDI: <a id="port2/pdi"></a>
                            </diagnostic>
                        </p>
                    </div>
                    <div id="framePort4" class="framePort">
                        <img class="portImage" id="pImage4"
                            src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D" width=100 height=110>
                        <p id="port4" class="port">
                            <b>Port 4</b>
                            <br>Device: <a id="port4/prodname"></a>
                            <br>Serial: <a id="port4/serial"></a>
                            <br>Status: <a id="port4/status"></a>
                            <diagnostic id="diagPort4">
                                <br>PDI: <a id="port4/pdi"></a>
                            </diagnostic>
                        </p>
                    </div>
                    <div id="framePort6" class="framePort">
                        <img class="portImage" id="pImage6"
                            src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D" width=100 height=110>
                        <p id="port6" class="port">
                            <b>Port 6</b>
                            <br>Device: <a id="port6/prodname"></a>
                            <br>Serial: <a id="port6/serial"></a>
                            <br>Status: <a id="port6/status"></a>
                            <diagnostic id="diagPort6">
                                <br>PDI: <a id="port6/pdi"></a>
                            </diagnostic>
                        </p>
                    </div>
                    <div id="framePort8" class="framePort">
                        <img class="portImage" id="pImage8"
                            src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D" width=100 height=110>
                        <p id="port8" class="port">
                            <b>Port 8</b>
                            <br>Device: <a id="port8/prodname"></a>
                            <br>Serial: <a id="port8/serial"></a>
                            <br>Status: <a id="port8/status"></a>
                            <diagnostic id="diagPort8">
                                <br>PDI: <a id="port8/pdi"></a>
                            </diagnostic>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="geral">
        <h1>Demo MQTT Data Explorer</h1>
        <ul id="myUL"> </ul>
    </div>

    <div class="geral">
        <h1>Demo MQTT Datalogger</h1>
        <p id="log"></p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <script type="text/javascript">


        //MQTT stuff
        var userpass = prompt("Username:", "GO_RO");
        var IOLM = new Object();
        var IOLMBaseTopic = "";
        var log = document.getElementById("log")

        function timestamp() {
            return new Date().getHours().toLocaleString('en-US', { minimumIntegerDigits: 2, useGrouping: false })
                + ":" + new Date().getMinutes().toLocaleString('en-US', { minimumIntegerDigits: 2, useGrouping: false })
                + ":" + new Date().getSeconds().toLocaleString('en-US', { minimumIntegerDigits: 2, useGrouping: false });
        }

        var t = "<b>" + timestamp() + " Trying to connect to the broker</b>";
        log.innerHTML = t + "<br><br>" + log.innerHTML;

        client = new Paho.MQTT.Client("amazing-electrician.cloudmqtt.com", 443, "web_" + parseInt(Math.random() * 100, 10));

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
        var options = {
            useSSL: true,
            userName: userpass,
            password: userpass,
            onSuccess: onConnect,
            onFailure: doFail
        }

        client.connect(options);


        var rISDU
        function onConnect() {
            // Once a connection has been made, make a subscription and send a message.
            console.log("onConnect");
            var t = "<b>" + timestamp() + " Connected to the broker!</b>";
            log.innerHTML = t + "<br><br>" + log.innerHTML;
            var t = "<b>" + timestamp() + " Subscribing to '#' </b>";
            log.innerHTML = t + "<br><br>" + log.innerHTML;
            client.subscribe("#");
            //rISDU = setInterval(requestISDU, 10000);

        }

        function requestISDU() {
            if (IOLM[IOLMBaseTopic]["port"]["1"]["status"]["state"] == "Operate") {
                var mmessage = new Paho.MQTT.Message("{\"op\": \"read\",\"index\": 65,\"format\": \"raw\"}");
                mmessage.destinationName = IOLMBaseTopic + "/port/1/isdu/request/index65";
                client.send(mmessage);
            }

        }

        function doFail(e) {
            console.log(e);
            var t = "<b>" + timestamp() + " Failed to connect to the broker!</b> Please, check if username is correct and if the broker is active. Refresh the page to try again.";
            log.innerHTML = t + "<br><br>" + log.innerHTML;
        }

        function onConnectionLost(responseObject) {
            clearInterval(rISDU);
            if (responseObject.errorCode !== 0) {
                console.log("onConnectionLost:" + responseObject.errorMessage);
                var t = "<b>" + timestamp() + " Lost connection to the broker!</b> Refresh the page to start again.";
                log.innerHTML = t + "<br><br>" + log.innerHTML;
            }
        }

        function getImgSrc(objectName) {
            switch (objectName) {
                case "NRB4-12GM40-E2-IO-C-V1":
                    return "https://files.pepperl-fuchs.com/webcat/navi/productInfo/pd/b243986a.png";
                    break;
                case "OMT550-R200-2EP-IO-V1":
                    return "https://files.pepperl-fuchs.com/webcat/navi/productInfo/pd/b248653a.png";
                    break;
                case "UC6000-30GM-IUEP-IO-V15":
                    return "https://files.pepperl-fuchs.com/webcat/navi/productInfo/pd/b235010a.png";
                    break;
                case "PMI40-F90-IU2EP-IO-V15":
                    return "https://files.pepperl-fuchs.com/webcat/navi/productInfo/pd/b246119a.png";
                    break;
                case "OBG5000-R100-2EP-IO-V31":
                    return "https://files.pepperl-fuchs.com/webcat/navi/productInfo/pd/b241434a.png";
                    break;
                default:
                    return "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D";
                    break;
            }
        }

        function startsWith(prodName, expression) {
            if (prodName.slice(0, expression.length) == expression) {
                return true;
            } else {
                return false;
            }
        }

        function findSensorType(prodName) {
            if (startsWith(prodName, "OMT")) {
                return "Dis+SS+Qlt";
            } else if (startsWith(prodName, "NR") ||
                startsWith(prodName, "OB")) {
                return "SS+Qlt";
            } else if (startsWith(prodName, "UC")) {
                return "Dis+SS";
            } else if (startsWith(prodName, "PMI")) {
                return "Dis+SS/PMI";
            } else {
                return "Unknown";
            }
        }

        function addTemplate(prodName, portNum) {
            var prodType = findSensorType(prodName).split("/");

            switch (prodType[0]) {
                case "SS+Qlt":
                    return "<br>Switching signal: <a id=\"port" + portNum + "/pdi\"></a>" +
                        "<br>Stability: <a id=\"port" + portNum + "/stability\"></a>";
                    break;
                case "Dis+SS":
                    return "<br>Distance: <a id=\"port" + portNum + "/pdi\"></a>" +
                        "<br>Switching signal: <a id=\"port" + portNum + "/signal\"></a>";
                    break;
                case "Dis+SS+Qlt":
                    return "<br>Distance: <a id=\"port" + portNum + "/pdi\"></a>" +
                        "<br>Switching signal: <a id=\"port" + portNum + "/signal\"></a>" +
                        "<br>Signal quality: <a id=\"port" + portNum + "/quality\"></a>";
                    break;
                default:
                    return "<br>PDI: <a id=\"port" + portNum + "/pdi\"></a>";
                    break;
            }
        }



        function onMessageArrived(message) {

            //Datalogger
            t = "<b>" + timestamp() + " " + message.destinationName + "</b>: " + message.payloadString;
            log.innerHTML = t + "<br><br>" + log.innerHTML;

            //Parsing IOLM data
            path = message.destinationName.split("/");
            var mIOLM = IOLM;
            if (IOLMBaseTopic == "") {
                IOLMBaseTopic = path[0];
            }
            for (i = 0; i < path.length - 1; i++) {
                if (mIOLM[path[i]] === undefined) {
                    mIOLM[path[i]] = new Object();
                }
                mIOLM = mIOLM[path[i]];
            }

            mIOLM[path[path.length - 1]] = JSON.parse(message.payloadString);
            console.log(IOLM);

            //Pass data to tree view
            var treeView = document.getElementById("myUL");
            //path exists?
            //if not, create path
            if (document.getElementById(message.destinationName) === null) {
                var mItem = path.shift();
                var relativePath = mItem;
                var pElement = treeView;
                for (var i = path.length; i >= 0; i--) {
                    if (document.getElementById(relativePath) === null) {
                        var newLI = document.createElement("li");
                        var newSpan = document.createElement("span");
                        var newUL = document.createElement("ul");
                        newUL.id = relativePath;
                        newUL.className = "nested";
                        newSpan.className = "caret";
                        newSpan.innerHTML = mItem;
                        newSpan.addEventListener("click", function () {
                            this.parentElement.querySelector(".nested").classList.toggle("active");
                            this.classList.toggle("caret-down");
                        });
                        newLI.appendChild(newSpan);
                        newLI.appendChild(newUL);
                        pElement.appendChild(newLI);
                    }
                    pElement = document.getElementById(relativePath);
                    mItem = path.shift();
                    relativePath = relativePath + "/" + mItem;
                }
            }
            //if yes, update data
            if (document.getElementById(message.destinationName) != null) {
                document.getElementById(message.destinationName).innerHTML = message.payloadString;
            }

            //update IOLM Status
            function findIOLMObject(mObject) {
                path = mObject.split("/");
                var mIOLM = IOLM;

                for (i = 0; i < path.length; i++) {
                    mIOLM = mIOLM[path[i]];
                }
                return mIOLM;
            }

            var portNum = message.destinationName.substr(message.destinationName.search("/port/") + 6, 1);
            if (portNum > 0) {
                var IOLMref = findIOLMObject(message.destinationName);
                var mPort = document.getElementById("framePort" + portNum);
                switch (message.destinationName) {
                    case IOLMBaseTopic + "/port/" + portNum + "/deviceinfo":
                        if (document.getElementById("port" + portNum + "/serial").innerHTML != IOLMref["serial"]) {
                            document.getElementById("port" + portNum + "/prodname").innerHTML = IOLMref["prodname"];
                            document.getElementById("port" + portNum + "/serial").innerHTML = IOLMref["serial"];
                            document.getElementById("pImage" + portNum).src = getImgSrc(IOLMref["prodname"]);

                            document.getElementById("diagPort" + portNum).innerHTML =
                                addTemplate(IOLMref["prodname"], portNum);
                        }
                        break;
                    case IOLMBaseTopic + "/port/" + portNum + "/status":
                        document.getElementById("port" + portNum + "/status").innerHTML = IOLMref["status"] + " - " + IOLMref["state"];

                        switch (document.getElementById("port" + portNum + "/status").innerHTML) {
                            case "Inactive - CommLost":
                                mPort.style.backgroundColor = "red";
                                break;
                            case "Inactive - Init":
                                mPort.style.backgroundColor = "lightgrey";
                                break;
                            default:
                                mPort.style.backgroundColor = "white";
                                break;
                        }

                        break;
                    case IOLMBaseTopic + "/port/" + portNum + "/pdi":

                        if (document.getElementById("port" + portNum + "/prodname").innerHTML != "") {
                            switch (findSensorType(document.getElementById("port" + portNum + "/prodname").innerHTML)) {
                                case "SS+Qlt":
                                    var sSignal = IOLMref["raw"][0] & 0b0001;
                                    var sStability = (IOLMref["raw"][0] & 0b0010) >> 1;

                                    document.getElementById("port" + portNum + "/pdi").innerHTML = sSignal;

                                    if (sStability == 1) {
                                        document.getElementById("port" + portNum + "/stability").innerHTML = "&nbspAlarm&nbsp";
                                        document.getElementById("port" + portNum + "/stability").style.backgroundColor = "yellow";
                                    } else {
                                        document.getElementById("port" + portNum + "/stability").innerHTML = "&nbspOK&nbsp";
                                        document.getElementById("port" + portNum + "/stability").style.backgroundColor = "transparent";
                                    }
                                    break;

                                case "Dis+SS":
                                    var sSignal1 = IOLMref["raw"][1] & 0b0001;
                                    var sSignal2 = (IOLMref["raw"][1] & 0b0010) >> 1;
                                    var sDistance = ((IOLMref["raw"][0]) << 6) + ((IOLMref["raw"][1] & 0b11111100) >> 2);

                                    if (sDistance == 16383) {
                                        document.getElementById("port" + portNum + "/pdi").innerHTML = "&nbspNo Echo&nbsp";
                                        document.getElementById("port" + portNum + "/pdi").style.backgroundColor = "red";
                                    } else {
                                        document.getElementById("port" + portNum + "/pdi").innerHTML = "&nbsp" + sDistance + " mm&nbsp";
                                        document.getElementById("port" + portNum + "/pdi").style.backgroundColor = "green";
                                    }

                                    document.getElementById("port" + portNum + "/signal").innerHTML = "&nbspSS1: " + sSignal1 + "   /   SS2: " + sSignal2;
                                    break;

                                case "Dis+SS/PMI":
                                    var sSignal1 = IOLMref["raw"][1] & 0b0001;
                                    var sSignal2 = (IOLMref["raw"][1] & 0b0010) >> 1;
                                    var sSignal3 = (IOLMref["raw"][1] & 0b0100) >> 2;
                                    var sDistance = ((IOLMref["raw"][0]) << 4) + ((IOLMref["raw"][1] & 0b11110000) >> 4);

                                    if (sDistance == 4092) {
                                        document.getElementById("port" + portNum + "/pdi").innerHTML = "&nbspInsufficient signal quality&nbsp";
                                        document.getElementById("port" + portNum + "/pdi").style.backgroundColor = "red";
                                    } else if (sDistance == 4093) {
                                        document.getElementById("port" + portNum + "/pdi").innerHTML = "&nbspBelow Detection Range&nbsp";
                                        document.getElementById("port" + portNum + "/pdi").style.backgroundColor = "red";
                                    } else if (sDistance == 4094) {
                                        document.getElementById("port" + portNum + "/pdi").innerHTML = "&nbspAbove Detection Range&nbsp";
                                        document.getElementById("port" + portNum + "/pdi").style.backgroundColor = "red";
                                    } else if (sDistance == 4095) {
                                        document.getElementById("port" + portNum + "/pdi").innerHTML = "&nbspNo Damping Element detected&nbsp";
                                        document.getElementById("port" + portNum + "/pdi").style.backgroundColor = "red";
                                    } else {
                                        document.getElementById("port" + portNum + "/pdi").innerHTML = "&nbsp" + (sDistance * 0.05).toFixed(2) + " mm&nbsp";
                                        document.getElementById("port" + portNum + "/pdi").style.backgroundColor = "green";
                                    }

                                    document.getElementById("port" + portNum + "/signal").innerHTML = "&nbspSS1: " + sSignal1 + "   /   SS2: " + sSignal2 + "   /   SS3: " + sSignal3;
                                    break;

                                case "Dis+SS+Qlt":
                                    var sSignal1 = IOLMref["raw"][3] & 0b0001;
                                    var sSignal2 = (IOLMref["raw"][3] & 0b0010) >> 1;
                                    var sQuality = (IOLMref["raw"][3] & 0b1100) >> 2;
                                    var sDistance = ((IOLMref["raw"][0]) << 8) + ((IOLMref["raw"][1]));

                                    if (sDistance == 32776) {
                                        document.getElementById("port" + portNum + "/pdi").innerHTML = "&nbspOut of Range - Below Range&nbsp";
                                    } else if (sDistance == 32760) {
                                        document.getElementById("port" + portNum + "/pdi").innerHTML = "&nbspOut of Range - Above Range&nbsp";
                                    } else if (sDistance == 32764) {
                                        document.getElementById("port" + portNum + "/pdi").innerHTML = "&nbspNo Measurement Data&nbsp";
                                    } else {
                                        document.getElementById("port" + portNum + "/pdi").innerHTML = "&nbsp" + (sDistance * 0.1).toFixed(1) + " mm&nbsp";
                                    }

                                    if (sQuality == 3) {
                                        document.getElementById("port" + portNum + "/quality").innerHTML = "&nbspExcellent&nbsp";
                                        document.getElementById("port" + portNum + "/quality").style.backgroundColor = "green";
                                    } else if (sQuality == 2) {
                                        document.getElementById("port" + portNum + "/quality").innerHTML = "&nbspGood&nbsp";
                                        document.getElementById("port" + portNum + "/quality").style.backgroundColor = "yellow";
                                    } else if (sQuality == 1) {
                                        document.getElementById("port" + portNum + "/quality").innerHTML = "&nbspAcceptable&nbsp";
                                        document.getElementById("port" + portNum + "/quality").style.backgroundColor = "orange";
                                    } else {
                                        document.getElementById("port" + portNum + "/quality").innerHTML = "&nbspInsufficient&nbsp";
                                        document.getElementById("port" + portNum + "/quality").style.backgroundColor = "red";
                                    }

                                    document.getElementById("port" + portNum + "/signal").innerHTML = "&nbspSS1: " + sSignal1 + "   /   SS2: " + sSignal2;
                                    break;

                                default:
                                    document.getElementById("port" + portNum + "/pdi").innerHTML = IOLMref["raw"];
                                    break;
                            }
                        } else {
                            document.getElementById("diagPort" + portNum).innerHTML = "";
                        }
                        break;

                    case IOLMBaseTopic + "/port/" + portNum + "/isdu/response/index65":
                        if (portNum < 3) {
                            if (IOLMref["status"] == "OK") {
                                switch (IOLMref["raw"][4]) {
                                    case 1:
                                        document.getElementById("port" + portNum + "/temperature").innerHTML =
                                            "Critical High Temperature";
                                        break;
                                    case 2:
                                        document.getElementById("port" + portNum + "/temperature").innerHTML =
                                            "Overtemperature";
                                        break;
                                    default:
                                        document.getElementById("port" + portNum + "/temperature").innerHTML =
                                            "OK";
                                        break;
                                }
                            }
                        }
                        break;

                    default:
                }
            }
        }

    </script>
</body>

</html>
